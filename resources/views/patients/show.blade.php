{{-- resources/views/patients/show.blade.php --}}
@extends('layouts.admission')

@section('content')

@if(session('success'))
<script>
    Swal.fire({
        icon: 'success',
        title: 'Success üéâ',
        html: `<b>{{ session('success') }}</b><br>
               Email: <code>{{ session('generatedEmail') }}</code><br>
               Password: <code>{{ session('plainPassword') }}</code>`,
        confirmButtonText: 'OK'
    });
</script>
@endif

@if(session('error'))
<script>
    Swal.fire({
        icon: 'error',
        title: 'Admission Failed ‚ùå',
        text: '{{ session('error') }}',
        confirmButtonText: 'Try Again'
    });
</script>
@endif


<div class="container-fluid py-4">

  {{-- Flash autogenerated credentials (only right after creation) --}}
  @if(session('generatedEmail') && session('plainPassword'))
    <div class="alert alert-success">
      <p><strong>Credentials:</strong></p>
      <p>Email: <code>{{ session('generatedEmail') }}</code></p>
      <p>Password: <code>{{ session('plainPassword') }}</code></p>
    </div>
  @endif

  {{-- Page Header --}}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-primary">
      Patient Details:
      {{ $patient->patient_first_name }} {{ $patient->patient_last_name }}
    </h2>
   <a href="{{ route('admission.patients.index') }}" class="btn btn-secondary">
      ‚Üê Back to Patients
    </a>
  </div>

  {{-- Personal Information --}}
  <div class="card mb-4">
    <div class="card-header">Personal Information</div>
    <div class="card-body">
      <p><strong>Email:</strong> {{ $patient->email }}</p>
      <p><strong>Password:</strong>
        @if(session('plainPassword'))
          <code>{{ session('plainPassword') }}</code>
        @else
          <span class="text-muted">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
        @endif
      </p>
      <p><strong>Phone:</strong> {{ $patient->phone_number ?? '‚Äî' }}</p>
      <p><strong>Birthday:</strong> {{ $patient->patient_birthday?->format('M d, Y') ?? '‚Äî' }}</p>
      <p><strong>Civil Status:</strong> {{ $patient->civil_status ?? '‚Äî' }}</p>
      <p><strong>Address:</strong> {{ $patient->address ?? '‚Äî' }}</p>
       <p><strong>Sex:</strong> {{ $patient->sex ?? '‚Äî' }}</p>
    </div>
  </div>

  {{-- Medical Details --}}
  <div class="card mb-4">
    <div class="card-header">Medical Details</div>
    <div class="card-body">
      <p><strong>Primary Reason:</strong> {{ $patient->medicalDetail?->primary_reason ?? '‚Äî' }}</p>
      <p><strong>Vitals:</strong>
        Weight {{ $patient->medicalDetail?->weight ?? '‚Äî' }} kg,
        Height {{ $patient->medicalDetail?->height ?? '‚Äî' }} cm,
        Temp {{ $patient->medicalDetail?->temperature ?? '‚Äî' }}¬∞F,
        BP {{ $patient->medicalDetail?->blood_pressure ?? '‚Äî' }},
        HR {{ $patient->medicalDetail?->heart_rate ?? '‚Äî' }} bpm
      </p>

      @php
       $history = $patient->medicalDetail?->medical_history;
  if (is_string($history)) {
      $history = json_decode($history, true) ?: [];
  } elseif (! is_array($history)) {
      $history = [];
  }

  $allergies = $patient->medicalDetail?->allergies;
  if (is_string($allergies)) {
      $allergies = json_decode($allergies, true) ?: [];
  } elseif (! is_array($allergies)) {
      $allergies = [];
  }
      @endphp

      <p><strong>Medical History:</strong></p>
      @if(empty($history) || (collect($history)->filter(fn($v,$k)=>$k!=='others' && $v)->isEmpty() && empty($history['others'])))
        <p>‚Äî</p>
      @else
        <ul>
          @foreach($history as $key => $value)
            @continue($key === 'others' || !$value)
            <li>{{ ucwords(str_replace('_',' ',$key)) }}</li>
          @endforeach
          @if(!empty($history['others']))
            <li>Other: {{ $history['others'] }}</li>
          @endif
        </ul>
      @endif

      <p><strong>Allergies:</strong></p>
      @if(empty($allergies) || (collect($allergies)->filter(fn($v,$k)=>$k!=='others' && $v)->isEmpty() && empty($allergies['others'])))
        <p>‚Äî</p>
      @else
        <ul>
          @foreach($allergies as $key => $value)
            @continue($key === 'others' || !$value)
            <li>
              {{ $key==='none'
                 ? 'No Known Allergies'
                 : ucwords(str_replace('_',' ',$key))
              }}
            </li>
          @endforeach
          @if(!empty($allergies['others']))
            <li>Other: {{ $allergies['others'] }}</li>
          @endif
        </ul>
      @endif
    </div>
  </div>

  {{-- Admission Details --}}
  <div class="card mb-4">
    <div class="card-header">Admission Details</div>
    <div class="card-body">
      <p><strong>Date:</strong> {{ $patient->admissionDetail?->admission_date?->format('M d, Y') ?? '‚Äî' }}</p>
      <p><strong>Type:</strong> {{ $patient->admissionDetail?->admission_type ?? '‚Äî' }}</p>
      <p><strong>Source:</strong> {{ $patient->admissionDetail?->admission_source ?? '‚Äî' }}</p>
      <p><strong>Department:</strong> {{ $patient->admissionDetail?->department?->department_name ?? '‚Äî' }}</p>
      <p><strong>Doctor:</strong> {{ $patient->admissionDetail?->doctor?->doctor_name ?? '‚Äî' }}</p>
      <p><strong>Room/Bed:</strong>
         {{ $patient->admissionDetail?->room_number ?? '‚Äî' }} /
         {{ $patient->admissionDetail?->bed_number ?? '‚Äî' }}
      </p>
      <p><strong>Notes:</strong> {{ $patient->admissionDetail?->admission_notes ?? '‚Äî' }}</p>
    </div>
  </div>

  {{-- Billing Information --}}
  <div class="card mb-4">
    <div class="card-header">Billing Information</div>
    <div class="card-body">

      <p><strong>Guarantor Name:</strong> {{ $patient->billingInformation?->guarantor_name ?? '‚Äî' }}</p>
      <p><strong>Guarantor Relationship:</strong> {{ $patient->billingInformation?->guarantor_relationship ?? '‚Äî' }}</p>
      <hr>
    </div>
  </div>
</div>
@endsection
